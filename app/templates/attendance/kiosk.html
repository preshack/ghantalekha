{% extends "base.html" %}
{% block title %}Clock In / Out  WorkClock{% endblock %}

{% block content %}
<div class="flex flex-col items-center justify-center min-h-[90vh] px-4 py-6">
    
    <!-- Header / Status -->
    <div class="text-center mb-8 w-full max-w-md">
        <h1 class="text-4xl font-light text-gray-800 dark:text-gray-100 tracking-wide mb-2" id="liveClock">--:--</h1>
        <p class="text-gray-500 dark:text-gray-400 text-sm font-medium uppercase tracking-wider" id="liveDate">...</p>
    </div>

    <!-- PIN Display Area -->
    <div class="mb-8 flex justify-center space-x-4">
        <div id="dot0" class="w-4 h-4 rounded-full border-2 border-gray-300 dark:border-gray-600 transition-all duration-200"></div>
        <div id="dot1" class="w-4 h-4 rounded-full border-2 border-gray-300 dark:border-gray-600 transition-all duration-200"></div>
        <div id="dot2" class="w-4 h-4 rounded-full border-2 border-gray-300 dark:border-gray-600 transition-all duration-200"></div>
        <div id="dot3" class="w-4 h-4 rounded-full border-2 border-gray-300 dark:border-gray-600 transition-all duration-200"></div>
    </div>

    <!-- Error Messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <div class="mb-6 w-full max-w-xs text-center">
                {% for category, message in messages %}
                    <div class="p-3 rounded-lg text-sm font-medium 
                        {% if category == 'error' %}bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-400
                        {% elif category == 'success' %}bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-400
                        {% else %}bg-blue-100 text-blue-700 dark:bg-blue-900/30 dark:text-blue-400{% endif %}">
                        {{ message }}
                    </div>
                {% endfor %}
            </div>
        {% endif %}
    {% endwith %}

    <!-- Numeric Keypad -->
    <div class="grid grid-cols-3 gap-4 w-full max-w-xs mb-8">
        {% for n in [1, 2, 3, 4, 5, 6, 7, 8, 9] %}
        <button type="button" onclick="window.kiosk.addDigit('{{ n }}')" class="keypad-btn h-16 rounded-2xl bg-white dark:bg-gray-800 shadow-sm border-b-4 border-gray-200 dark:border-gray-700 active:border-b-0 active:translate-y-1 text-2xl font-semibold text-gray-700 dark:text-gray-200 hover:bg-gray-50 dark:hover:bg-gray-700 transition-all select-none touch-manipulation">
            {{ n }}
        </button>
        {% endfor %}
        
        <button type="button" onclick="window.kiosk.clearPin()" class="keypad-btn h-16 rounded-2xl bg-gray-100 dark:bg-gray-800/50 shadow-sm border-b-4 border-gray-200 dark:border-gray-700 active:border-b-0 active:translate-y-1 text-sm font-bold text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 transition-all uppercase tracking-wider flex items-center justify-center select-none touch-manipulation">
            CLR
        </button>
        
        <button type="button" onclick="window.kiosk.addDigit('0')" class="keypad-btn h-16 rounded-2xl bg-white dark:bg-gray-800 shadow-sm border-b-4 border-gray-200 dark:border-gray-700 active:border-b-0 active:translate-y-1 text-2xl font-semibold text-gray-700 dark:text-gray-200 hover:bg-gray-50 dark:hover:bg-gray-700 transition-all select-none touch-manipulation">
            0
        </button>
        
        <button type="button" onclick="window.kiosk.backspace()" class="keypad-btn h-16 rounded-2xl bg-gray-100 dark:bg-gray-800/50 shadow-sm border-b-4 border-gray-200 dark:border-gray-700 active:border-b-0 active:translate-y-1 text-gray-500 hover:text-gray-700 dark:hover:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-700 transition-all flex items-center justify-center select-none touch-manipulation">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2M3 12l6.414 6.414a2 2 0 001.414.586H19a2 2 0 002-2V7a2 2 0 00-2-2h-8.172a2 2 0 00-1.414.586L3 12z"></path></svg>
        </button>
    </div>

    <!-- Hidden Form -->
    <form id="pinForm" method="POST" action="{{ url_for('attendance.clock') }}">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <input type="hidden" name="pin" id="pinInput">
        <input type="hidden" name="gps_lat" id="gpsLat">
        <input type="hidden" name="gps_lng" id="gpsLng">
    </form>
    
    <!-- Link to Manager Login -->
    <div class="mt-4">
        <a href="{{ url_for('auth.login') }}" class="text-sm font-medium text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 transition-colors">
            Manager Login
        </a>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingIndicator" class="hidden fixed inset-0 bg-white/80 dark:bg-gray-900/80 backdrop-blur-sm z-50 flex flex-col items-center justify-center">
        <div class="w-12 h-12 border-4 border-brand-500 border-t-transparent rounded-full animate-spin mb-4"></div>
        <p class="text-gray-600 dark:text-gray-300 font-medium animate-pulse">Processing...</p>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Self-contained Kiosk Logic
    window.kiosk = (function() {
        let pin = '';
        const MAX_PIN = 4;
        let submitting = false;

        function updateClock() {
            const now = new Date();
            const timeEl = document.getElementById('liveClock');
            const dateEl = document.getElementById('liveDate');
            if(timeEl) timeEl.textContent = now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            if(dateEl) dateEl.textContent = now.toLocaleDateString([], {weekday: 'long', month:'short', day:'numeric'});
        }
        setInterval(updateClock, 1000);
        updateClock();

        function updateDots() {
            for(let i=0; i<4; i++) {
                const dot = document.getElementById('dot'+i);
                if (!dot) continue;
                if(i < pin.length) {
                    dot.classList.add('bg-blue-600', 'border-blue-600', 'dark:bg-blue-500', 'dark:border-blue-500');
                    dot.classList.remove('border-gray-300', 'dark:border-gray-600');
                } else {
                    dot.classList.remove('bg-blue-600', 'border-blue-600', 'dark:bg-blue-500', 'dark:border-blue-500');
                    dot.classList.add('border-gray-300', 'dark:border-gray-600');
                }
            }
        }

        function submit() {
            if (submitting) return;
            submitting = true;
            document.getElementById('loadingIndicator').classList.remove('hidden');
            
            // Set the hidden input value!
            const pinInput = document.getElementById('pinInput');
            pinInput.value = pin;
            
            const form = document.getElementById('pinForm');
            
            // Capture GPS?
            if(navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(pos => {
                    document.getElementById('gpsLat').value = pos.coords.latitude;
                    document.getElementById('gpsLng').value = pos.coords.longitude;
                    form.submit();
                }, () => {
                    form.submit(); // Submit anyway on error
                }, {timeout: 3000});
            } else {
                form.submit();
            }
        }

        return {
            addDigit: function(d) {
                if(submitting || pin.length >= MAX_PIN) return;
                pin += d;
                updateDots();
                if(pin.length === MAX_PIN) {
                    // Small delay for visual feedback
                    setTimeout(submit, 100);
                }
            },
            backspace: function() {
                if(submitting) return;
                pin = pin.slice(0, -1);
                updateDots();
            },
            clearPin: function() {
                if(submitting) return;
                pin = '';
                updateDots();
            }
        };
    })();

    // Keyboard support
    document.addEventListener('keydown', e => {
        if(e.key >= '0' && e.key <= '9') window.kiosk.addDigit(e.key);
        if(e.key === 'Backspace') window.kiosk.backspace();
        if(e.key === 'Escape') window.kiosk.clearPin();
    });
</script>
{% endblock %}
